name: Audio Auto-Repair v4.1

on:
  push:
    branches: [main]
    paths:
      - 'public/audio/**'
      - 'public/data/**/*.json'
      - 'public/audio/manifest.json'
  workflow_dispatch:
    inputs:
      apply_fixes:
        description: 'Apply fixes (true) or dry-run only (false)'
        required: false
        default: 'false'
        type: boolean
      rooms:
        description: 'Room filter pattern (optional, e.g., "vip1")'
        required: false
        default: ''
        type: string

jobs:
  audio-repair:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      # ============================================
      # RUN AUDIO TESTS
      # ============================================
      
      - name: Run Audio Tests
        id: audio_tests
        run: |
          npx vitest run src/lib/audio --reporter=verbose 2>&1 | tee test-results.log
          if [ $? -eq 0 ]; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          else
            echo "tests_passed=false" >> $GITHUB_OUTPUT
          fi

      # ============================================
      # GENERATE MANIFEST
      # ============================================
      
      - name: Generate Audio Manifest
        run: node scripts/generate-audio-manifest.js

      # ============================================
      # DRY-RUN CHECKS (audio:check)
      # ============================================
      
      - name: Run JSON Refresh (dry-run)
        id: dry_run_refresh
        run: |
          ROOM_FILTER="${{ github.event.inputs.rooms }}"
          if [ -n "$ROOM_FILTER" ]; then
            npx tsx scripts/refresh-json-audio.ts --dry-run --verbose --rooms "$ROOM_FILTER" 2>&1 | tee refresh-dry.log
          else
            npx tsx scripts/refresh-json-audio.ts --dry-run --verbose 2>&1 | tee refresh-dry.log
          fi
          
          FIXES=$(grep -oP "Total fixes needed: \K\d+" refresh-dry.log || echo "0")
          SCANNED=$(grep -oP "Rooms scanned: \K\d+" refresh-dry.log || echo "0")
          REVERSALS=$(grep -oP "Reversed-lang fixes: \K\d+" refresh-dry.log || echo "0")
          
          echo "json_fixes=$FIXES" >> $GITHUB_OUTPUT
          echo "rooms_scanned=$SCANNED" >> $GITHUB_OUTPUT
          echo "reversals=$REVERSALS" >> $GITHUB_OUTPUT

      - name: Detect Orphan Files (dry-run)
        id: orphan_check
        run: |
          npx tsx scripts/cleanup-orphans.ts --dry-run 2>&1 | tee orphan-dry.log
          
          ORPHANS=$(grep -oP "Total orphan files: \K\d+" orphan-dry.log || echo "0")
          ATTACHABLE=$(grep -oP "Attachable.*: \K\d+" orphan-dry.log || echo "0")
          DANGEROUS=$(grep -oP "Dangerous.*: \K\d+" orphan-dry.log || echo "0")
          
          echo "orphan_count=$ORPHANS" >> $GITHUB_OUTPUT
          echo "attachable=$ATTACHABLE" >> $GITHUB_OUTPUT
          echo "dangerous=$DANGEROUS" >> $GITHUB_OUTPUT

      - name: Check Rename Operations (dry-run)
        id: rename_check
        run: |
          npx tsx scripts/rename-audio-storage.ts --dry-run --verbose 2>&1 | tee rename-dry.log
          
          RENAMES=$(grep -oP "Total renames needed: \K\d+" rename-dry.log || echo "0")
          DUPS=$(grep -oP "Duplicate moves: \K\d+" rename-dry.log || echo "0")
          
          echo "rename_count=$RENAMES" >> $GITHUB_OUTPUT
          echo "duplicate_count=$DUPS" >> $GITHUB_OUTPUT

      # ============================================
      # CONDITIONAL APPLY (audio:fix)
      # ============================================
      
      - name: Apply Fixes
        if: |
          github.event.inputs.apply_fixes == 'true' || 
          (github.event_name == 'push' && (steps.dry_run_refresh.outputs.json_fixes != '0' || steps.rename_check.outputs.rename_count != '0'))
        run: |
          echo "ðŸ”§ Applying automated fixes..."
          
          # Apply JSON fixes
          ROOM_FILTER="${{ github.event.inputs.rooms }}"
          if [ -n "$ROOM_FILTER" ]; then
            npx tsx scripts/refresh-json-audio.ts --apply --verbose --rooms "$ROOM_FILTER"
          else
            npx tsx scripts/refresh-json-audio.ts --apply --verbose
          fi
          
          # Apply renames
          npx tsx scripts/rename-audio-storage.ts --verbose
          
          # Auto-fix attachable orphans
          npx tsx scripts/cleanup-orphans.ts --auto-fix
          
          # Regenerate manifest after all fixes
          node scripts/generate-audio-manifest.js
          
          echo "âœ… Fixes applied successfully!"

      # ============================================
      # COMMIT & PUSH
      # ============================================
      
      - name: Check for Changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git status --porcelain | head -20
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit All Changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "automation@mercyblade.app"
          git config --local user.name "Audio Automation Bot v4.1"
          
          git add public/audio/manifest.json || true
          git add public/audio/*.mp3 || true
          git add public/audio/_duplicates/*.mp3 || true
          git add public/data/*.json || true
          git add public/*.json || true
          
          git commit -m "[skip ci] Audio Auto-Repair v4.1" \
            -m "Rooms: ${{ steps.dry_run_refresh.outputs.rooms_scanned }}" \
            -m "JSON fixes: ${{ steps.dry_run_refresh.outputs.json_fixes }}" \
            -m "Reversals: ${{ steps.dry_run_refresh.outputs.reversals }}" \
            -m "Orphans: ${{ steps.orphan_check.outputs.orphan_count }}" \
            -m "Renames: ${{ steps.rename_check.outputs.rename_count }}" \
            -m "Duplicates: ${{ steps.rename_check.outputs.duplicate_count }}"
          
          git push

      # ============================================
      # SUMMARY REPORT
      # ============================================
      
      - name: Generate Summary Report
        run: |
          # Calculate integrity estimate
          TOTAL_ISSUES=$(( ${{ steps.dry_run_refresh.outputs.json_fixes }} + ${{ steps.orphan_check.outputs.orphan_count }} + ${{ steps.rename_check.outputs.rename_count }} ))
          ROOMS=${{ steps.dry_run_refresh.outputs.rooms_scanned }}
          if [ "$ROOMS" -gt 0 ] && [ "$TOTAL_ISSUES" -gt 0 ]; then
            AVG_SCORE=$(( 100 - (TOTAL_ISSUES * 100 / (ROOMS * 2)) ))
            [ "$AVG_SCORE" -lt 0 ] && AVG_SCORE=0
          else
            AVG_SCORE=100
          fi
          
          echo "## ðŸŽµ Audio Auto-Repair v4.1 Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test Results
          echo "### ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.audio_tests.outputs.tests_passed }}" == "true" ]; then
            echo "âœ… All audio tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some tests failed - check logs" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Integrity Summary
          echo "### ðŸ“Š Integrity Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rooms Scanned | ${{ steps.dry_run_refresh.outputs.rooms_scanned }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Avg Integrity Score | ~${AVG_SCORE}% |" >> $GITHUB_STEP_SUMMARY
          echo "| JSON Fixes Needed | ${{ steps.dry_run_refresh.outputs.json_fixes }} |" >> $GITHUB_STEP_SUMMARY
          echo "| EN/VI Reversals | ${{ steps.dry_run_refresh.outputs.reversals }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Orphan Files | ${{ steps.orphan_check.outputs.orphan_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Attachable Orphans | ${{ steps.orphan_check.outputs.attachable }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dangerous Orphans | ${{ steps.orphan_check.outputs.dangerous }} |" >> $GITHUB_STEP_SUMMARY
          echo "| File Renames | ${{ steps.rename_check.outputs.rename_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Duplicates Detected | ${{ steps.rename_check.outputs.duplicate_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Changes Committed | ${{ steps.changes.outputs.has_changes }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Mode
          echo "### ðŸ”§ Mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.apply_fixes }}" == "true" ]; then
            echo "âœ… **Fixes were applied** (manual trigger with apply_fixes=true)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **Auto-applied on push** (issues detected and fixed)" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Dry-run only** - No changes made" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Commands
          echo "### ðŸ’» Local Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Dry-run checks (audio:check)" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/refresh-json-audio.ts --dry-run --verbose" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/cleanup-orphans.ts --dry-run" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/rename-audio-storage.ts --dry-run --verbose" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Apply fixes (audio:fix)" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/refresh-json-audio.ts --apply --verbose" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/rename-audio-storage.ts --verbose" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/cleanup-orphans.ts --auto-fix" >> $GITHUB_STEP_SUMMARY
          echo "node scripts/generate-audio-manifest.js" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Run audio tests (test:audio)" >> $GITHUB_STEP_SUMMARY
          echo "npx vitest run src/lib/audio" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # GitHub trigger
          echo "### ðŸš€ Trigger via CLI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'gh workflow run "Audio Auto-Repair v4.1" -f apply_fixes=true' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
