name: Audio Auto-Repair v5.0

on:
  push:
    branches: [main]
    paths:
      - 'public/audio/**'
      - 'public/data/**/*.json'
      - 'public/audio/manifest.json'
  workflow_dispatch:
    inputs:
      apply_fixes:
        description: 'Apply fixes (true) or dry-run only (false)'
        required: false
        default: 'false'
        type: boolean
      rooms:
        description: 'Room filter pattern (optional, e.g., "vip1")'
        required: false
        default: ''
        type: string

jobs:
  audio-repair:
    runs-on: ubuntu-latest
    outputs:
      integrity_before: ${{ steps.verify_before.outputs.integrity }}
      integrity_after: ${{ steps.verify_after.outputs.integrity }}
      total_repairs: ${{ steps.apply_fixes.outputs.total_repairs }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      # ============================================
      # PHASE 1: AUDIO CHECK (audio:check)
      # ============================================
      
      - name: Run Audio Tests
        id: audio_tests
        run: |
          npx vitest run src/lib/audio --reporter=verbose 2>&1 | tee test-results.log
          if [ $? -eq 0 ]; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          else
            echo "tests_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Audio Manifest (no-timestamp mode)
        run: node scripts/generate-audio-manifest.js --no-timestamp

      - name: Run JSON Refresh (dry-run, no-timestamp)
        id: dry_run_refresh
        run: |
          ROOM_FILTER="${{ github.event.inputs.rooms }}"
          if [ -n "$ROOM_FILTER" ]; then
            npx tsx scripts/refresh-json-audio.ts --dry-run --verbose --no-timestamp --rooms "$ROOM_FILTER" 2>&1 | tee refresh-dry.log
          else
            npx tsx scripts/refresh-json-audio.ts --dry-run --verbose --no-timestamp 2>&1 | tee refresh-dry.log
          fi
          
          FIXES=$(grep -oP "Total fixes needed: \K\d+" refresh-dry.log || echo "0")
          SCANNED=$(grep -oP "Rooms scanned: \K\d+" refresh-dry.log || echo "0")
          REVERSALS=$(grep -oP "Reversed-lang fixes: \K\d+" refresh-dry.log || echo "0")
          CRITICAL=$(grep -oP "critical: \K\d+" refresh-dry.log || echo "0")
          STRUCTURAL=$(grep -oP "structural: \K\d+" refresh-dry.log || echo "0")
          COSMETIC=$(grep -oP "cosmetic: \K\d+" refresh-dry.log || echo "0")
          
          echo "json_fixes=$FIXES" >> $GITHUB_OUTPUT
          echo "rooms_scanned=$SCANNED" >> $GITHUB_OUTPUT
          echo "reversals=$REVERSALS" >> $GITHUB_OUTPUT
          echo "critical_fixes=$CRITICAL" >> $GITHUB_OUTPUT
          echo "structural_fixes=$STRUCTURAL" >> $GITHUB_OUTPUT
          echo "cosmetic_fixes=$COSMETIC" >> $GITHUB_OUTPUT

      - name: Detect Orphan Files (dry-run, no-timestamp)
        id: orphan_check
        run: |
          npx tsx scripts/cleanup-orphans.ts --dry-run --no-timestamp 2>&1 | tee orphan-dry.log
          
          ORPHANS=$(grep -oP "Total orphan files: \K\d+" orphan-dry.log || echo "0")
          AUTO_ATTACH=$(grep -oP "Auto-attach.*: \K\d+" orphan-dry.log || echo "0")
          FLAG_REVIEW=$(grep -oP "Flag for review.*: \K\d+" orphan-dry.log || echo "0")
          BLOCKED=$(grep -oP "Blocked.*: \K\d+" orphan-dry.log || echo "0")
          
          echo "orphan_count=$ORPHANS" >> $GITHUB_OUTPUT
          echo "auto_attach=$AUTO_ATTACH" >> $GITHUB_OUTPUT
          echo "flag_review=$FLAG_REVIEW" >> $GITHUB_OUTPUT
          echo "blocked=$BLOCKED" >> $GITHUB_OUTPUT

      - name: Check Rename Operations (dry-run, no-timestamp)
        id: rename_check
        run: |
          npx tsx scripts/rename-audio-storage.ts --dry-run --verbose --no-timestamp 2>&1 | tee rename-dry.log
          
          RENAMES=$(grep -oP "Total renames needed: \K\d+" rename-dry.log || echo "0")
          DUPS=$(grep -oP "Duplicate moves: \K\d+" rename-dry.log || echo "0")
          
          echo "rename_count=$RENAMES" >> $GITHUB_OUTPUT
          echo "duplicate_count=$DUPS" >> $GITHUB_OUTPUT

      - name: Check if fixes needed (only critical/structural)
        id: needs_fix
        run: |
          # Only count critical and structural issues, not cosmetic
          CRITICAL=${{ steps.dry_run_refresh.outputs.critical_fixes }}
          STRUCTURAL=${{ steps.dry_run_refresh.outputs.structural_fixes }}
          ORPHANS=${{ steps.orphan_check.outputs.auto_attach }}
          RENAMES=${{ steps.rename_check.outputs.rename_count }}
          
          TOTAL_ACTIONABLE=$((CRITICAL + STRUCTURAL + ORPHANS + RENAMES))
          TOTAL_ALL=$(( ${{ steps.dry_run_refresh.outputs.json_fixes }} + ${{ steps.orphan_check.outputs.orphan_count }} + RENAMES ))
          
          if [ "$TOTAL_ACTIONABLE" -gt 0 ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi
          
          echo "total_issues=$TOTAL_ALL" >> $GITHUB_OUTPUT
          echo "actionable_issues=$TOTAL_ACTIONABLE" >> $GITHUB_OUTPUT
          echo "Total issues: $TOTAL_ALL (Actionable: $TOTAL_ACTIONABLE)"

      # ============================================
      # PHASE 2: AUDIO FIX (audio:fix) - AUTOPILOT
      # ============================================
      
      - name: Calculate Integrity Before
        id: verify_before
        run: |
          TOTAL=${{ steps.needs_fix.outputs.total_issues }}
          ROOMS=${{ steps.dry_run_refresh.outputs.rooms_scanned }}
          if [ "$ROOMS" -gt 0 ] && [ "$TOTAL" -gt 0 ]; then
            INTEGRITY=$(( 100 - (TOTAL * 100 / (ROOMS * 2)) ))
            [ "$INTEGRITY" -lt 0 ] && INTEGRITY=0
          else
            INTEGRITY=100
          fi
          echo "integrity=$INTEGRITY" >> $GITHUB_OUTPUT
          echo "System integrity before: $INTEGRITY%"
      
      - name: Apply Fixes (Autopilot - only if actionable issues exist)
        id: apply_fixes
        if: |
          github.event.inputs.apply_fixes == 'true' || 
          (github.event_name == 'push' && steps.needs_fix.outputs.has_issues == 'true')
        run: |
          echo "ü§ñ AUTOPILOT MODE: Applying automated fixes..."
          REPAIRS=0
          
          # Apply JSON fixes
          ROOM_FILTER="${{ github.event.inputs.rooms }}"
          if [ -n "$ROOM_FILTER" ]; then
            npx tsx scripts/refresh-json-audio.ts --apply --verbose --rooms "$ROOM_FILTER" 2>&1 | tee json-fix.log
          else
            npx tsx scripts/refresh-json-audio.ts --apply --verbose 2>&1 | tee json-fix.log
          fi
          JSON_FIXED=$(grep -oP "Total fixes applied: \K\d+" json-fix.log || echo "0")
          REPAIRS=$((REPAIRS + JSON_FIXED))
          
          # Apply renames
          npx tsx scripts/rename-audio-storage.ts --verbose 2>&1 | tee rename-fix.log
          RENAMES_FIXED=$(grep -oP "Files renamed: \K\d+" rename-fix.log || echo "0")
          REPAIRS=$((REPAIRS + RENAMES_FIXED))
          
          # Auto-fix attachable orphans only
          npx tsx scripts/cleanup-orphans.ts --auto-fix 2>&1 | tee orphan-fix.log
          ORPHANS_FIXED=$(grep -oP "Auto-attached: \K\d+" orphan-fix.log || echo "0")
          REPAIRS=$((REPAIRS + ORPHANS_FIXED))
          
          # Regenerate manifest (full mode with timestamp)
          node scripts/generate-audio-manifest.js
          
          echo "total_repairs=$REPAIRS" >> $GITHUB_OUTPUT
          echo "‚úÖ Autopilot applied $REPAIRS repairs"

      # ============================================
      # PHASE 3: AUDIO VERIFY
      # ============================================
      
      - name: Verify System Integrity After
        id: verify_after
        run: |
          # Re-run dry checks to calculate new integrity
          npx tsx scripts/refresh-json-audio.ts --dry-run --no-timestamp 2>&1 | tee verify-refresh.log
          npx tsx scripts/cleanup-orphans.ts --dry-run --no-timestamp 2>&1 | tee verify-orphan.log
          npx tsx scripts/rename-audio-storage.ts --dry-run --no-timestamp 2>&1 | tee verify-rename.log
          
          NEW_JSON=$(grep -oP "Total fixes needed: \K\d+" verify-refresh.log || echo "0")
          NEW_ORPHANS=$(grep -oP "Total orphan files: \K\d+" verify-orphan.log || echo "0")
          NEW_RENAMES=$(grep -oP "Total renames needed: \K\d+" verify-rename.log || echo "0")
          
          NEW_TOTAL=$((NEW_JSON + NEW_ORPHANS + NEW_RENAMES))
          ROOMS=${{ steps.dry_run_refresh.outputs.rooms_scanned }}
          
          if [ "$ROOMS" -gt 0 ] && [ "$NEW_TOTAL" -gt 0 ]; then
            INTEGRITY=$(( 100 - (NEW_TOTAL * 100 / (ROOMS * 2)) ))
            [ "$INTEGRITY" -lt 0 ] && INTEGRITY=0
          else
            INTEGRITY=100
          fi
          
          echo "integrity=$INTEGRITY" >> $GITHUB_OUTPUT
          echo "remaining_issues=$NEW_TOTAL" >> $GITHUB_OUTPUT
          echo "System integrity after: $INTEGRITY%"

      - name: Check Integrity Gate (‚â•99% for Phase 5)
        id: integrity_gate
        run: |
          INTEGRITY=${{ steps.verify_after.outputs.integrity }}
          THRESHOLD=99
          
          if [ "$INTEGRITY" -lt "$THRESHOLD" ]; then
            echo "‚ö†Ô∏è WARNING: System integrity ($INTEGRITY%) below threshold ($THRESHOLD%)"
            echo "gate_passed=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ System integrity ($INTEGRITY%) meets threshold ($THRESHOLD%)"
            echo "gate_passed=true" >> $GITHUB_OUTPUT
          fi

      # ============================================
      # PHASE 4: COMMIT & REPORT (No Surprise Mode)
      # ============================================
      
      - name: Check for Actual Changes (No Surprise Mode)
        id: changes
        run: |
          # Only consider actual content changes, not timestamp-only changes
          git diff --name-only > changed-files.txt
          
          # Filter to only audio/data files
          grep -E "^(public/audio|public/data)" changed-files.txt > relevant-changes.txt || true
          
          CHANGE_COUNT=$(wc -l < relevant-changes.txt | tr -d ' ')
          
          if [ "$CHANGE_COUNT" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "change_count=$CHANGE_COUNT" >> $GITHUB_OUTPUT
            echo "Changed files ($CHANGE_COUNT):"
            cat relevant-changes.txt | head -30
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "change_count=0" >> $GITHUB_OUTPUT
            echo "No actual content changes detected"
          fi

      - name: Generate Change-Set JSON (Audit Trail)
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          cat > public/audio-changeset.json << EOF
          {
            "generatedAt": "$(date -Iseconds)",
            "workflowRun": "${{ github.run_id }}",
            "trigger": "${{ github.event_name }}",
            "applyFixes": "${{ github.event.inputs.apply_fixes }}",
            "integrityBefore": ${{ steps.verify_before.outputs.integrity }},
            "integrityAfter": ${{ steps.verify_after.outputs.integrity }},
            "totalRepairs": ${{ steps.apply_fixes.outputs.total_repairs || 0 }},
            "changedFiles": $(cat relevant-changes.txt | jq -R . | jq -s .),
            "categories": {
              "critical": ${{ steps.dry_run_refresh.outputs.critical_fixes || 0 }},
              "structural": ${{ steps.dry_run_refresh.outputs.structural_fixes || 0 }},
              "cosmetic": ${{ steps.dry_run_refresh.outputs.cosmetic_fixes || 0 }}
            }
          }
          EOF
          echo "Change-set JSON generated"

      - name: Commit All Changes (only if actual changes exist)
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "automation@mercyblade.app"
          git config --local user.name "Audio Autopilot v5.0"
          
          # Recursive add for all nested files
          git add public/audio || true
          git add public/data || true
          git add public/*.json || true
          
          git commit -m "[skip ci] Audio Auto-Repair v5.0 (Phase 5 Autopilot)" \
            -m "ü§ñ Zero-Friction Autopilot: Fully Autonomous" \
            -m "" \
            -m "Integrity: ${{ steps.verify_before.outputs.integrity }}% ‚Üí ${{ steps.verify_after.outputs.integrity }}%" \
            -m "Repairs Applied: ${{ steps.apply_fixes.outputs.total_repairs || 0 }}" \
            -m "Files Changed: ${{ steps.changes.outputs.change_count }}" \
            -m "" \
            -m "Categories:" \
            -m "  üî¥ Critical: ${{ steps.dry_run_refresh.outputs.critical_fixes || 0 }}" \
            -m "  üü° Structural: ${{ steps.dry_run_refresh.outputs.structural_fixes || 0 }}" \
            -m "  üü¢ Cosmetic: ${{ steps.dry_run_refresh.outputs.cosmetic_fixes || 0 }}"
          
          git push

      # ============================================
      # SUMMARY REPORT
      # ============================================
      
      - name: Generate Summary Report
        run: |
          BEFORE=${{ steps.verify_before.outputs.integrity }}
          AFTER=${{ steps.verify_after.outputs.integrity }}
          REPAIRS=${{ steps.apply_fixes.outputs.total_repairs || 0 }}
          GATE=${{ steps.integrity_gate.outputs.gate_passed }}
          CHANGES=${{ steps.changes.outputs.change_count || 0 }}
          
          echo "## ü§ñ Audio Autopilot v5.0 Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Status Badge
          if [ "$GATE" == "true" ]; then
            echo "### ‚úÖ PASSED - System Healthy (‚â•99%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ö†Ô∏è WARNING - Below Threshold (<99%)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # No Surprise Mode indicator
          if [ "$CHANGES" == "0" ]; then
            echo "### üîí No Surprise Mode: No commits made (no actual changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### üìù Changes Committed: $CHANGES files" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test Results
          echo "### üß™ Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.audio_tests.outputs.tests_passed }}" == "true" ]; then
            echo "‚úÖ All audio tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Integrity Summary
          echo "### üìä System Integrity" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Before | After |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Integrity Score** | ${BEFORE}% | ${AFTER}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **Threshold** | 99% | 99% |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$AFTER" -ge "$BEFORE" ]; then
            DELTA="‚Üë +$((AFTER - BEFORE))%"
          else
            DELTA="‚Üì -$((BEFORE - AFTER))%"
          fi
          echo "| **Change** | - | $DELTA |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Category Breakdown
          echo "### üìã Fix Categories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Count | Action |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üî¥ Critical | ${{ steps.dry_run_refresh.outputs.critical_fixes || 0 }} | Auto-fix |" >> $GITHUB_STEP_SUMMARY
          echo "| üü° Structural | ${{ steps.dry_run_refresh.outputs.structural_fixes || 0 }} | Auto-fix |" >> $GITHUB_STEP_SUMMARY
          echo "| üü¢ Cosmetic | ${{ steps.dry_run_refresh.outputs.cosmetic_fixes || 0 }} | Skipped (dry-run only) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Repairs Applied
          echo "### üîß Repairs Applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Repairs | $REPAIRS |" >> $GITHUB_STEP_SUMMARY
          echo "| JSON Fixes | ${{ steps.dry_run_refresh.outputs.json_fixes }} |" >> $GITHUB_STEP_SUMMARY
          echo "| EN/VI Reversals | ${{ steps.dry_run_refresh.outputs.reversals }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Orphans Auto-Attached | ${{ steps.orphan_check.outputs.auto_attach }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Orphans Flagged | ${{ steps.orphan_check.outputs.flag_review }} |" >> $GITHUB_STEP_SUMMARY
          echo "| File Renames | ${{ steps.rename_check.outputs.rename_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Duplicates Moved | ${{ steps.rename_check.outputs.duplicate_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Governance
          echo "### üõ°Ô∏è Governance (Phase 5)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Auto-Approved (‚â•92%)**: High confidence repairs" >> $GITHUB_STEP_SUMMARY
          echo "- **Flagged (75-91%)**: Needs human review" >> $GITHUB_STEP_SUMMARY
          echo "- **Blocked (<75%)**: Not auto-fixed" >> $GITHUB_STEP_SUMMARY
          echo "- **Remaining Issues**: ${{ steps.verify_after.outputs.remaining_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Commands
          echo "### üíª Local Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "npm run audio:check    # Dry-run all checks" >> $GITHUB_STEP_SUMMARY
          echo "npm run audio:fix      # Apply all fixes" >> $GITHUB_STEP_SUMMARY
          echo "npm run test:audio     # Run audio tests" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üîó Trigger CLI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'gh workflow run "Audio Auto-Repair v5.0" -f apply_fixes=true' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
