name: Audio Auto-Repair v4.0

on:
  push:
    branches: [main]
    paths:
      - 'public/audio/**'
      - 'public/data/**/*.json'
      - 'public/audio/manifest.json'
  workflow_dispatch:
    inputs:
      apply_fixes:
        description: 'Apply fixes (true) or dry-run only (false)'
        required: false
        default: 'false'
        type: boolean
      rooms:
        description: 'Room filter pattern (optional, e.g., "vip1")'
        required: false
        default: ''
        type: string

jobs:
  audio-repair:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate Audio Manifest
        run: node scripts/generate-audio-manifest.js

      # ============================================
      # DRY-RUN CHECKS
      # ============================================
      
      - name: Run JSON Refresh (dry-run)
        id: dry_run_refresh
        run: |
          ROOM_FILTER="${{ github.event.inputs.rooms }}"
          if [ -n "$ROOM_FILTER" ]; then
            npx tsx scripts/refresh-json-audio.ts --dry-run --verbose --rooms "$ROOM_FILTER" 2>&1 | tee refresh-dry.log
          else
            npx tsx scripts/refresh-json-audio.ts --dry-run --verbose 2>&1 | tee refresh-dry.log
          fi
          
          if grep -q "Total fixes needed:" refresh-dry.log; then
            FIXES=$(grep "Total fixes needed:" refresh-dry.log | awk '{print $NF}')
            echo "json_fixes=$FIXES" >> $GITHUB_OUTPUT
          else
            echo "json_fixes=0" >> $GITHUB_OUTPUT
          fi
          
          if grep -q "Rooms scanned:" refresh-dry.log; then
            SCANNED=$(grep "Rooms scanned:" refresh-dry.log | awk '{print $NF}')
            echo "rooms_scanned=$SCANNED" >> $GITHUB_OUTPUT
          else
            echo "rooms_scanned=0" >> $GITHUB_OUTPUT
          fi
          
          if grep -q "Reversed-lang fixes:" refresh-dry.log; then
            REVERSALS=$(grep "Reversed-lang fixes:" refresh-dry.log | awk '{print $NF}')
            echo "reversals=$REVERSALS" >> $GITHUB_OUTPUT
          else
            echo "reversals=0" >> $GITHUB_OUTPUT
          fi

      - name: Detect Orphan Files (dry-run)
        id: orphan_check
        run: |
          npx tsx scripts/cleanup-orphans.ts --dry-run 2>&1 | tee orphan-dry.log
          
          if grep -q "Total orphan files:" orphan-dry.log; then
            ORPHANS=$(grep "Total orphan files:" orphan-dry.log | awk '{print $NF}')
            echo "orphan_count=$ORPHANS" >> $GITHUB_OUTPUT
          else
            echo "orphan_count=0" >> $GITHUB_OUTPUT
          fi
          
          if grep -q "Attachable" orphan-dry.log; then
            ATTACHABLE=$(grep "Attachable" orphan-dry.log | grep -oP '\d+' | head -1)
            echo "attachable=$ATTACHABLE" >> $GITHUB_OUTPUT
          else
            echo "attachable=0" >> $GITHUB_OUTPUT
          fi

      - name: Check Rename Operations (dry-run)
        id: rename_check
        run: |
          npx tsx scripts/rename-audio-storage.ts --dry-run --verbose 2>&1 | tee rename-dry.log
          
          if grep -q "Total renames needed:" rename-dry.log; then
            RENAMES=$(grep "Total renames needed:" rename-dry.log | awk '{print $NF}')
            echo "rename_count=$RENAMES" >> $GITHUB_OUTPUT
          else
            echo "rename_count=0" >> $GITHUB_OUTPUT
          fi

      # ============================================
      # CONDITIONAL APPLY
      # ============================================
      
      - name: Apply Fixes
        if: |
          github.event.inputs.apply_fixes == 'true' || 
          (github.event_name == 'push' && (steps.dry_run_refresh.outputs.json_fixes != '0' || steps.rename_check.outputs.rename_count != '0'))
        run: |
          echo "Applying automated fixes..."
          
          # Apply JSON fixes
          ROOM_FILTER="${{ github.event.inputs.rooms }}"
          if [ -n "$ROOM_FILTER" ]; then
            npx tsx scripts/refresh-json-audio.ts --apply --verbose --rooms "$ROOM_FILTER"
          else
            npx tsx scripts/refresh-json-audio.ts --apply --verbose
          fi
          
          # Apply renames
          npx tsx scripts/rename-audio-storage.ts --verbose
          
          # Auto-fix attachable orphans
          npx tsx scripts/cleanup-orphans.ts --auto-fix
          
          # Regenerate manifest after all fixes
          node scripts/generate-audio-manifest.js
          
          echo "Fixes applied successfully!"

      # ============================================
      # COMMIT & PUSH
      # ============================================
      
      - name: Check for Changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git status --porcelain | head -20
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit All Changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "automation@mercyblade.app"
          git config --local user.name "Audio Automation Bot v4.0"
          
          # Stage all audio and data changes
          git add public/audio/manifest.json || true
          git add public/audio/*.mp3 || true
          git add public/data/*.json || true
          git add public/*.json || true
          
          # Commit with detailed message
          git commit -m "[skip ci] Audio Auto-Repair v4.0: GCE Integration" \
            -m "Rooms scanned: ${{ steps.dry_run_refresh.outputs.rooms_scanned }}" \
            -m "JSON fixes: ${{ steps.dry_run_refresh.outputs.json_fixes }}" \
            -m "Reversals fixed: ${{ steps.dry_run_refresh.outputs.reversals }}" \
            -m "Orphans detected: ${{ steps.orphan_check.outputs.orphan_count }}" \
            -m "Attachable orphans: ${{ steps.orphan_check.outputs.attachable }}" \
            -m "Renames applied: ${{ steps.rename_check.outputs.rename_count }}"
          
          git push

      # ============================================
      # SUMMARY REPORT
      # ============================================
      
      - name: Generate Summary Report
        run: |
          echo "## ðŸŽµ Audio Auto-Repair v4.0 Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rooms Scanned | ${{ steps.dry_run_refresh.outputs.rooms_scanned }} |" >> $GITHUB_STEP_SUMMARY
          echo "| JSON Fixes | ${{ steps.dry_run_refresh.outputs.json_fixes }} |" >> $GITHUB_STEP_SUMMARY
          echo "| EN/VI Reversals | ${{ steps.dry_run_refresh.outputs.reversals }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Orphan Files | ${{ steps.orphan_check.outputs.orphan_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Attachable Orphans | ${{ steps.orphan_check.outputs.attachable }} |" >> $GITHUB_STEP_SUMMARY
          echo "| File Renames | ${{ steps.rename_check.outputs.rename_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Changes Committed | ${{ steps.changes.outputs.has_changes }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.apply_fixes }}" == "true" ]; then
            echo "âœ… **Fixes were applied**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **Auto-applied on push (issues detected)**" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Dry-run only** - No changes made" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Local Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Dry-run checks" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/refresh-json-audio.ts --dry-run --verbose" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/cleanup-orphans.ts --dry-run" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/rename-audio-storage.ts --dry-run --verbose" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Apply fixes" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/refresh-json-audio.ts --apply --verbose" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/rename-audio-storage.ts --verbose" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/cleanup-orphans.ts --auto-fix" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
