name: Audio Auto-Repair v4.3

on:
  push:
    branches: [main]
    paths:
      - 'public/audio/**'
      - 'public/data/**/*.json'
      - 'public/audio/manifest.json'
  workflow_dispatch:
    inputs:
      apply_fixes:
        description: 'Apply fixes (true) or dry-run only (false)'
        required: false
        default: 'false'
        type: boolean
      rooms:
        description: 'Room filter pattern (optional, e.g., "vip1")'
        required: false
        default: ''
        type: string

jobs:
  audio-repair:
    runs-on: ubuntu-latest
    outputs:
      integrity_before: ${{ steps.verify_before.outputs.integrity }}
      integrity_after: ${{ steps.verify_after.outputs.integrity }}
      total_repairs: ${{ steps.apply_fixes.outputs.total_repairs }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      # ============================================
      # PHASE 1: AUDIO CHECK (audio:check)
      # ============================================
      
      - name: Run Audio Tests
        id: audio_tests
        run: |
          npx vitest run src/lib/audio --reporter=verbose 2>&1 | tee test-results.log
          if [ $? -eq 0 ]; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          else
            echo "tests_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Audio Manifest (dry-run mode)
        run: node scripts/generate-audio-manifest.js --no-timestamp

      - name: Run JSON Refresh (dry-run)
        id: dry_run_refresh
        run: |
          ROOM_FILTER="${{ github.event.inputs.rooms }}"
          if [ -n "$ROOM_FILTER" ]; then
            npx tsx scripts/refresh-json-audio.ts --dry-run --verbose --rooms "$ROOM_FILTER" 2>&1 | tee refresh-dry.log
          else
            npx tsx scripts/refresh-json-audio.ts --dry-run --verbose 2>&1 | tee refresh-dry.log
          fi
          
          FIXES=$(grep -oP "Total fixes needed: \K\d+" refresh-dry.log || echo "0")
          SCANNED=$(grep -oP "Rooms scanned: \K\d+" refresh-dry.log || echo "0")
          REVERSALS=$(grep -oP "Reversed-lang fixes: \K\d+" refresh-dry.log || echo "0")
          
          echo "json_fixes=$FIXES" >> $GITHUB_OUTPUT
          echo "rooms_scanned=$SCANNED" >> $GITHUB_OUTPUT
          echo "reversals=$REVERSALS" >> $GITHUB_OUTPUT

      - name: Detect Orphan Files (dry-run)
        id: orphan_check
        run: |
          npx tsx scripts/cleanup-orphans.ts --dry-run 2>&1 | tee orphan-dry.log
          
          ORPHANS=$(grep -oP "Total orphan files: \K\d+" orphan-dry.log || echo "0")
          ATTACHABLE=$(grep -oP "Attachable.*: \K\d+" orphan-dry.log || echo "0")
          DANGEROUS=$(grep -oP "Dangerous.*: \K\d+" orphan-dry.log || echo "0")
          
          echo "orphan_count=$ORPHANS" >> $GITHUB_OUTPUT
          echo "attachable=$ATTACHABLE" >> $GITHUB_OUTPUT
          echo "dangerous=$DANGEROUS" >> $GITHUB_OUTPUT

      - name: Check Rename Operations (dry-run)
        id: rename_check
        run: |
          npx tsx scripts/rename-audio-storage.ts --dry-run --verbose 2>&1 | tee rename-dry.log
          
          RENAMES=$(grep -oP "Total renames needed: \K\d+" rename-dry.log || echo "0")
          DUPS=$(grep -oP "Duplicate moves: \K\d+" rename-dry.log || echo "0")
          
          echo "rename_count=$RENAMES" >> $GITHUB_OUTPUT
          echo "duplicate_count=$DUPS" >> $GITHUB_OUTPUT

      - name: Check if fixes needed
        id: needs_fix
        run: |
          TOTAL_ISSUES=$(( ${{ steps.dry_run_refresh.outputs.json_fixes }} + ${{ steps.orphan_check.outputs.orphan_count }} + ${{ steps.rename_check.outputs.rename_count }} ))
          if [ "$TOTAL_ISSUES" -gt 0 ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi
          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "Total issues detected: $TOTAL_ISSUES"

      # ============================================
      # PHASE 2: AUDIO FIX (audio:fix) - AUTOPILOT
      # ============================================
      
      - name: Calculate Integrity Before
        id: verify_before
        run: |
          # Simple integrity calculation based on issues
          TOTAL=${{ steps.needs_fix.outputs.total_issues }}
          ROOMS=${{ steps.dry_run_refresh.outputs.rooms_scanned }}
          if [ "$ROOMS" -gt 0 ] && [ "$TOTAL" -gt 0 ]; then
            INTEGRITY=$(( 100 - (TOTAL * 100 / (ROOMS * 2)) ))
            [ "$INTEGRITY" -lt 0 ] && INTEGRITY=0
          else
            INTEGRITY=100
          fi
          echo "integrity=$INTEGRITY" >> $GITHUB_OUTPUT
          echo "System integrity before: $INTEGRITY%"
      
      - name: Apply Fixes (Autopilot)
        id: apply_fixes
        if: |
          github.event.inputs.apply_fixes == 'true' || 
          (github.event_name == 'push' && steps.needs_fix.outputs.has_issues == 'true')
        run: |
          echo "ðŸ¤– AUTOPILOT MODE: Applying automated fixes..."
          REPAIRS=0
          
          # Apply JSON fixes
          ROOM_FILTER="${{ github.event.inputs.rooms }}"
          if [ -n "$ROOM_FILTER" ]; then
            npx tsx scripts/refresh-json-audio.ts --apply --verbose --rooms "$ROOM_FILTER" 2>&1 | tee json-fix.log
          else
            npx tsx scripts/refresh-json-audio.ts --apply --verbose 2>&1 | tee json-fix.log
          fi
          JSON_FIXED=$(grep -oP "Applied: \K\d+" json-fix.log || echo "0")
          REPAIRS=$((REPAIRS + JSON_FIXED))
          
          # Apply renames
          npx tsx scripts/rename-audio-storage.ts --verbose 2>&1 | tee rename-fix.log
          RENAMES_FIXED=$(grep -oP "Renamed: \K\d+" rename-fix.log || echo "0")
          REPAIRS=$((REPAIRS + RENAMES_FIXED))
          
          # Auto-fix attachable orphans
          npx tsx scripts/cleanup-orphans.ts --auto-fix 2>&1 | tee orphan-fix.log
          ORPHANS_FIXED=$(grep -oP "Fixed: \K\d+" orphan-fix.log || echo "0")
          REPAIRS=$((REPAIRS + ORPHANS_FIXED))
          
          # Regenerate manifest (full mode with timestamp)
          node scripts/generate-audio-manifest.js
          
          echo "total_repairs=$REPAIRS" >> $GITHUB_OUTPUT
          echo "âœ… Autopilot applied $REPAIRS repairs"

      # ============================================
      # PHASE 3: AUDIO VERIFY
      # ============================================
      
      - name: Verify System Integrity After
        id: verify_after
        run: |
          # Re-run dry checks to calculate new integrity
          npx tsx scripts/refresh-json-audio.ts --dry-run 2>&1 | tee verify-refresh.log
          npx tsx scripts/cleanup-orphans.ts --dry-run 2>&1 | tee verify-orphan.log
          npx tsx scripts/rename-audio-storage.ts --dry-run 2>&1 | tee verify-rename.log
          
          NEW_JSON=$(grep -oP "Total fixes needed: \K\d+" verify-refresh.log || echo "0")
          NEW_ORPHANS=$(grep -oP "Total orphan files: \K\d+" verify-orphan.log || echo "0")
          NEW_RENAMES=$(grep -oP "Total renames needed: \K\d+" verify-rename.log || echo "0")
          
          NEW_TOTAL=$((NEW_JSON + NEW_ORPHANS + NEW_RENAMES))
          ROOMS=${{ steps.dry_run_refresh.outputs.rooms_scanned }}
          
          if [ "$ROOMS" -gt 0 ] && [ "$NEW_TOTAL" -gt 0 ]; then
            INTEGRITY=$(( 100 - (NEW_TOTAL * 100 / (ROOMS * 2)) ))
            [ "$INTEGRITY" -lt 0 ] && INTEGRITY=0
          else
            INTEGRITY=100
          fi
          
          echo "integrity=$INTEGRITY" >> $GITHUB_OUTPUT
          echo "remaining_issues=$NEW_TOTAL" >> $GITHUB_OUTPUT
          echo "System integrity after: $INTEGRITY%"

      - name: Check Integrity Gate
        id: integrity_gate
        run: |
          INTEGRITY=${{ steps.verify_after.outputs.integrity }}
          THRESHOLD=98
          
          if [ "$INTEGRITY" -lt "$THRESHOLD" ]; then
            echo "âš ï¸ WARNING: System integrity ($INTEGRITY%) below threshold ($THRESHOLD%)"
            echo "gate_passed=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… System integrity ($INTEGRITY%) meets threshold ($THRESHOLD%)"
            echo "gate_passed=true" >> $GITHUB_OUTPUT
          fi

      # ============================================
      # PHASE 4: COMMIT & REPORT
      # ============================================
      
      - name: Check for Changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed files:"
            git status --porcelain | head -30
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Commit All Changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "automation@mercyblade.app"
          git config --local user.name "Audio Autopilot v4.3"
          
          # Recursive add for all nested files
          git add public/audio || true
          git add public/data || true
          git add public/*.json || true
          
          git commit -m "[skip ci] Audio Auto-Repair v4.3 (Autopilot)" \
            -m "ðŸ¤– Autopilot Mode: Fully Autonomous" \
            -m "" \
            -m "Integrity: ${{ steps.verify_before.outputs.integrity }}% â†’ ${{ steps.verify_after.outputs.integrity }}%" \
            -m "Repairs Applied: ${{ steps.apply_fixes.outputs.total_repairs || 0 }}" \
            -m "Rooms Scanned: ${{ steps.dry_run_refresh.outputs.rooms_scanned }}" \
            -m "JSON Fixes: ${{ steps.dry_run_refresh.outputs.json_fixes }}" \
            -m "Orphans: ${{ steps.orphan_check.outputs.orphan_count }}" \
            -m "Renames: ${{ steps.rename_check.outputs.rename_count }}" \
            -m "Duplicates: ${{ steps.rename_check.outputs.duplicate_count }}"
          
          git push

      # ============================================
      # SUMMARY REPORT
      # ============================================
      
      - name: Generate Summary Report
        run: |
          BEFORE=${{ steps.verify_before.outputs.integrity }}
          AFTER=${{ steps.verify_after.outputs.integrity }}
          REPAIRS=${{ steps.apply_fixes.outputs.total_repairs || 0 }}
          GATE=${{ steps.integrity_gate.outputs.gate_passed }}
          
          echo "## ðŸ¤– Audio Autopilot v4.3 Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Status Badge
          if [ "$GATE" == "true" ]; then
            echo "### âœ… PASSED - System Healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ WARNING - Below Threshold" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test Results
          echo "### ðŸ§ª Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.audio_tests.outputs.tests_passed }}" == "true" ]; then
            echo "âœ… All audio tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Integrity Summary
          echo "### ðŸ“Š System Integrity" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Before | After |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Integrity Score** | ${BEFORE}% | ${AFTER}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **Threshold** | 98% | 98% |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$AFTER" -ge "$BEFORE" ]; then
            DELTA="â†‘ +$((AFTER - BEFORE))%"
          else
            DELTA="â†“ -$((BEFORE - AFTER))%"
          fi
          echo "| **Change** | - | $DELTA |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Repairs Applied
          echo "### ðŸ”§ Repairs Applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Repairs | $REPAIRS |" >> $GITHUB_STEP_SUMMARY
          echo "| JSON Fixes | ${{ steps.dry_run_refresh.outputs.json_fixes }} |" >> $GITHUB_STEP_SUMMARY
          echo "| EN/VI Reversals | ${{ steps.dry_run_refresh.outputs.reversals }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Orphan Attachments | ${{ steps.orphan_check.outputs.attachable }} |" >> $GITHUB_STEP_SUMMARY
          echo "| File Renames | ${{ steps.rename_check.outputs.rename_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Duplicates Moved | ${{ steps.rename_check.outputs.duplicate_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Governance
          echo "### ðŸ›¡ï¸ Governance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Auto-Approved**: High confidence repairs (â‰¥90%)" >> $GITHUB_STEP_SUMMARY
          echo "- **Governance-Approved**: Medium confidence (70-89%)" >> $GITHUB_STEP_SUMMARY
          echo "- **Blocked**: Low confidence or critical violations" >> $GITHUB_STEP_SUMMARY
          echo "- **Remaining Issues**: ${{ steps.verify_after.outputs.remaining_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Mode
          echo "### ðŸš€ Mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.apply_fixes }}" == "true" ]; then
            echo "âœ… **Manual Trigger** (apply_fixes=true)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "ðŸ¤– **Autopilot** (auto-applied on push)" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Dry-run** (no changes needed)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Commands
          echo "### ðŸ’» Local Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "npm run audio:check    # Dry-run all checks" >> $GITHUB_STEP_SUMMARY
          echo "npm run audio:fix      # Apply all fixes" >> $GITHUB_STEP_SUMMARY
          echo "npm run test:audio     # Run audio tests" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ”— Trigger CLI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'gh workflow run "Audio Auto-Repair v4.3" -f apply_fixes=true' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
