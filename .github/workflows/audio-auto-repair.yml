name: Audio Auto-Repair v4.5

on:
  push:
    branches: [main]
    paths:
      - 'public/audio/**'
      - 'public/data/**/*.json'
      - 'public/audio/manifest.json'
  workflow_dispatch:
    inputs:
      apply_fixes:
        description: 'Apply fixes (true) or dry-run only (false)'
        required: false
        default: 'false'
        type: boolean
      rooms:
        description: 'Room filter pattern (optional, e.g., "vip1")'
        required: false
        default: ''
        type: string
      run_autopilot:
        description: 'Run full autopilot cycle'
        required: false
        default: 'false'
        type: boolean

jobs:
  # ============================================
  # JOB 1: AUTOPILOT CYCLE (v4.5)
  # ============================================
  run-autopilot-cycle:
    runs-on: ubuntu-latest
    outputs:
      integrity_before: ${{ steps.autopilot.outputs.integrity_before }}
      integrity_after: ${{ steps.autopilot.outputs.integrity_after }}
      total_changes: ${{ steps.autopilot.outputs.total_changes }}
      changes_applied: ${{ steps.autopilot.outputs.changes_applied }}
      changes_blocked: ${{ steps.autopilot.outputs.changes_blocked }}
      meets_threshold: ${{ steps.autopilot.outputs.meets_threshold }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      # ============================================
      # PHASE 1: AUDIO TESTS
      # ============================================
      
      - name: Run Audio Tests
        id: audio_tests
        run: |
          npx vitest run src/lib/audio --reporter=verbose 2>&1 | tee test-results.log
          if [ $? -eq 0 ]; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          else
            echo "tests_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Audio Manifest (no-timestamp mode)
        run: node scripts/generate-audio-manifest.js --no-timestamp

      # ============================================
      # PHASE 2: AUTOPILOT CYCLE (DRY-RUN OR APPLY)
      # ============================================
      
      - name: Run Autopilot Cycle
        id: autopilot
        run: |
          ROOM_FILTER="${{ github.event.inputs.rooms }}"
          APPLY_MODE="${{ github.event.inputs.apply_fixes }}"
          RUN_AUTOPILOT="${{ github.event.inputs.run_autopilot }}"
          
          # Determine mode
          if [ "$APPLY_MODE" == "true" ] || [ "$RUN_AUTOPILOT" == "true" ]; then
            MODE="--apply"
          else
            MODE="--dry-run"
          fi
          
          # Build command
          CMD="npx tsx scripts/run-audio-autopilot.ts $MODE --verbose"
          if [ -n "$ROOM_FILTER" ]; then
            CMD="$CMD --rooms \"$ROOM_FILTER\""
          fi
          
          echo "Running: $CMD"
          eval $CMD 2>&1 | tee autopilot-output.log
          
          # Extract metrics from output
          BEFORE=$(grep -oP "Before Integrity: \K[\d.]+" autopilot-output.log || echo "0")
          AFTER=$(grep -oP "After Integrity: \K[\d.]+" autopilot-output.log || echo "0")
          TOTAL=$(grep -oP "Total Changes: \K\d+" autopilot-output.log || echo "0")
          APPLIED=$(grep -oP "Applied: \K\d+" autopilot-output.log || echo "0")
          BLOCKED=$(grep -oP "Blocked: \K\d+" autopilot-output.log || echo "0")
          
          echo "integrity_before=$BEFORE" >> $GITHUB_OUTPUT
          echo "integrity_after=$AFTER" >> $GITHUB_OUTPUT
          echo "total_changes=$TOTAL" >> $GITHUB_OUTPUT
          echo "changes_applied=$APPLIED" >> $GITHUB_OUTPUT
          echo "changes_blocked=$BLOCKED" >> $GITHUB_OUTPUT
          
          # Check threshold
          AFTER_INT=${AFTER%.*}
          if [ "$AFTER_INT" -ge 99 ]; then
            echo "meets_threshold=true" >> $GITHUB_OUTPUT
          else
            echo "meets_threshold=false" >> $GITHUB_OUTPUT
          fi

      # ============================================
      # PHASE 3: INTEGRITY GATE (‚â•99%)
      # ============================================
      
      - name: Check Integrity Gate
        id: integrity_gate
        run: |
          AFTER="${{ steps.autopilot.outputs.integrity_after }}"
          THRESHOLD=99
          
          # Handle decimal comparison
          AFTER_INT=$(echo "$AFTER" | cut -d. -f1)
          
          if [ "$AFTER_INT" -lt "$THRESHOLD" ]; then
            echo "‚ö†Ô∏è WARNING: System integrity ($AFTER%) below threshold ($THRESHOLD%)"
            echo "gate_passed=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ System integrity ($AFTER%) meets threshold ($THRESHOLD%)"
            echo "gate_passed=true" >> $GITHUB_OUTPUT
          fi

      # ============================================
      # PHASE 4: UPLOAD ARTIFACTS
      # ============================================
      
      - name: Upload Autopilot Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: autopilot-artifacts
          path: |
            public/audio/autopilot-status.json
            public/audio/autopilot-report.json
            public/audio/autopilot-changeset.json
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Logs
        uses: actions/upload-artifact@v4
        with:
          name: autopilot-logs
          path: |
            autopilot-output.log
            test-results.log
          retention-days: 7

      # ============================================
      # PHASE 5: CHECK FOR CHANGES (No Surprise Mode)
      # ============================================
      
      - name: Check for Actual Changes
        id: changes
        run: |
          git diff --name-only > changed-files.txt
          
          # Filter to only audio/data files
          grep -E "^(public/audio|public/data)" changed-files.txt > relevant-changes.txt || true
          
          CHANGE_COUNT=$(wc -l < relevant-changes.txt | tr -d ' ')
          
          if [ "$CHANGE_COUNT" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "change_count=$CHANGE_COUNT" >> $GITHUB_OUTPUT
            echo "Changed files ($CHANGE_COUNT):"
            cat relevant-changes.txt | head -30
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "change_count=0" >> $GITHUB_OUTPUT
            echo "No actual content changes detected"
          fi

      # ============================================
      # PHASE 6: COMMIT (only if changes exist and apply mode)
      # ============================================
      
      - name: Commit Changes
        if: |
          steps.changes.outputs.has_changes == 'true' && 
          (github.event.inputs.apply_fixes == 'true' || github.event.inputs.run_autopilot == 'true')
        run: |
          git config --local user.email "automation@mercyblade.app"
          git config --local user.name "Audio Autopilot v4.5"
          
          # Add all relevant files
          git add public/audio || true
          git add public/data || true
          
          git commit -m "[skip ci] Audio Autopilot v4.5 - Governed Repairs" \
            -m "ü§ñ Full Autopilot with Governance Engine" \
            -m "" \
            -m "Integrity: ${{ steps.autopilot.outputs.integrity_before }}% ‚Üí ${{ steps.autopilot.outputs.integrity_after }}%" \
            -m "Changes: ${{ steps.autopilot.outputs.total_changes }} total (${{ steps.autopilot.outputs.changes_applied }} applied, ${{ steps.autopilot.outputs.changes_blocked }} blocked)" \
            -m "Gate: ${{ steps.integrity_gate.outputs.gate_passed && '‚úÖ PASSED' || '‚ö†Ô∏è BELOW THRESHOLD' }}"
          
          git push

      # ============================================
      # SUMMARY REPORT
      # ============================================
      
      - name: Generate Summary Report
        run: |
          BEFORE=${{ steps.autopilot.outputs.integrity_before }}
          AFTER=${{ steps.autopilot.outputs.integrity_after }}
          TOTAL=${{ steps.autopilot.outputs.total_changes }}
          APPLIED=${{ steps.autopilot.outputs.changes_applied }}
          BLOCKED=${{ steps.autopilot.outputs.changes_blocked }}
          GATE=${{ steps.integrity_gate.outputs.gate_passed }}
          CHANGES=${{ steps.changes.outputs.change_count || 0 }}
          
          echo "## ü§ñ Audio Autopilot v4.5 Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Status Badge
          if [ "$GATE" == "true" ]; then
            echo "### ‚úÖ PASSED - System Healthy (‚â•99%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ö†Ô∏è WARNING - Below Threshold (<99%)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test Results
          echo "### üß™ Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.audio_tests.outputs.tests_passed }}" == "true" ]; then
            echo "‚úÖ All audio tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Integrity Summary
          echo "### üìä System Integrity" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Before | After |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Integrity Score** | ${BEFORE}% | ${AFTER}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **Threshold** | 99% | 99% |" >> $GITHUB_STEP_SUMMARY
          
          # Calculate delta
          if [ -n "$BEFORE" ] && [ -n "$AFTER" ]; then
            BEFORE_INT=${BEFORE%.*}
            AFTER_INT=${AFTER%.*}
            if [ "$AFTER_INT" -ge "$BEFORE_INT" ]; then
              DELTA="‚Üë +$((AFTER_INT - BEFORE_INT))%"
            else
              DELTA="‚Üì -$((BEFORE_INT - AFTER_INT))%"
            fi
            echo "| **Change** | - | $DELTA |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Changes Summary
          echo "### üîß Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Changes | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| Applied | $APPLIED |" >> $GITHUB_STEP_SUMMARY
          echo "| Blocked | $BLOCKED |" >> $GITHUB_STEP_SUMMARY
          echo "| Files Changed | $CHANGES |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Artifacts
          echo "### üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`autopilot-status.json\` - Persistent status store" >> $GITHUB_STEP_SUMMARY
          echo "- \`autopilot-report.json\` - Full run report" >> $GITHUB_STEP_SUMMARY
          echo "- \`autopilot-changeset.json\` - Categorized changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Commands
          echo "### üíª Local Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Dry-run autopilot locally" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/run-audio-autopilot.ts --dry-run --verbose" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Apply autopilot fixes" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/run-audio-autopilot.ts --apply --verbose" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      # ============================================
      # FAIL IF INTEGRITY GATE NOT PASSED (optional enforcement)
      # ============================================
      
      - name: Enforce Integrity Gate
        if: steps.integrity_gate.outputs.gate_passed == 'false' && github.event.inputs.apply_fixes == 'true'
        run: |
          echo "‚ùå Integrity gate failed: System integrity below 99%"
          echo "Review the autopilot report and address blocking issues"
          exit 1
