name: Audio Auto-Repair v4.6

on:
  push:
    branches: [main]
    paths:
      - 'public/audio/**'
      - 'public/data/**/*.json'
      - 'public/audio/manifest.json'
  workflow_dispatch:
    inputs:
      apply_fixes:
        description: 'Apply fixes (true) or dry-run only (false)'
        required: false
        default: 'false'
        type: boolean
      rooms:
        description: 'Room filter pattern (optional, e.g., "vip1")'
        required: false
        default: ''
        type: string
      run_autopilot:
        description: 'Run full autopilot cycle'
        required: false
        default: 'false'
        type: boolean
      cycle_mode:
        description: 'Cycle mode: fast (skip TTS/semantic), deep (full), or normal'
        required: false
        default: 'normal'
        type: choice
        options:
          - fast
          - normal
          - deep

# ============================================
# CONCURRENCY: Job-level mutex (Phase 4.6)
# Only one autopilot run at a time per branch
# ============================================
concurrency:
  group: audio-autopilot-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================
  # JOB 1: AUTOPILOT CYCLE (v4.6)
  # ============================================
  run-autopilot-cycle:
    runs-on: ubuntu-latest
    outputs:
      integrity_before: ${{ steps.read_artifacts.outputs.integrity_before }}
      integrity_after: ${{ steps.read_artifacts.outputs.integrity_after }}
      total_changes: ${{ steps.read_artifacts.outputs.total_changes }}
      changes_applied: ${{ steps.read_artifacts.outputs.changes_applied }}
      changes_blocked: ${{ steps.read_artifacts.outputs.changes_blocked }}
      meets_threshold: ${{ steps.read_artifacts.outputs.meets_threshold }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      # ============================================
      # PHASE 1: AUDIO TESTS
      # ============================================
      
      - name: Run Audio Tests
        id: audio_tests
        run: |
          npx vitest run src/lib/audio --reporter=verbose 2>&1 | tee test-results.log
          if [ $? -eq 0 ]; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          else
            echo "tests_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Enforce Test Pass
        if: steps.audio_tests.outputs.tests_passed != 'true'
        run: |
          echo "‚ùå Audio tests failed - blocking autopilot cycle"
          exit 1

      - name: Generate Audio Manifest (no-timestamp mode)
        run: node scripts/generate-audio-manifest.js --no-timestamp

      # ============================================
      # PHASE 2: AUTOPILOT CYCLE (DRY-RUN OR APPLY)
      # ============================================
      
      - name: Run Autopilot Cycle
        id: autopilot
        run: |
          ROOM_FILTER="${{ github.event.inputs.rooms }}"
          APPLY_MODE="${{ github.event.inputs.apply_fixes }}"
          RUN_AUTOPILOT="${{ github.event.inputs.run_autopilot }}"
          CYCLE_MODE="${{ github.event.inputs.cycle_mode || 'normal' }}"
          
          # Determine mode
          if [ "$APPLY_MODE" == "true" ] || [ "$RUN_AUTOPILOT" == "true" ]; then
            MODE="--apply"
          else
            MODE="--dry-run"
          fi
          
          # Build command
          CMD="npx tsx scripts/run-audio-autopilot.ts $MODE --verbose"
          
          # Add room filter
          if [ -n "$ROOM_FILTER" ]; then
            CMD="$CMD --rooms \"$ROOM_FILTER\""
          fi
          
          # Add cycle mode (Phase 4.6)
          if [ "$CYCLE_MODE" == "fast" ]; then
            CMD="$CMD --fast"
          elif [ "$CYCLE_MODE" == "deep" ]; then
            CMD="$CMD --deep"
          fi
          
          # Add cycle label for tracking
          CMD="$CMD --cycle-label \"ci-run-${{ github.run_number }}\""
          
          echo "Running: $CMD"
          eval $CMD 2>&1 | tee autopilot-output.log

      # ============================================
      # PHASE 3: VALIDATE ARTIFACTS (Phase 4.6)
      # ============================================
      
      - name: Validate Artifacts
        id: validate_artifacts
        run: |
          ARTIFACTS_VALID="true"
          
          # Check and validate each artifact file
          for artifact in "autopilot-status.json" "autopilot-report.json" "autopilot-changeset.json"; do
            FILE="public/audio/$artifact"
            if [ ! -f "$FILE" ]; then
              echo "‚ö†Ô∏è Missing artifact: $FILE"
              ARTIFACTS_VALID="false"
            else
              # Validate JSON syntax
              if ! jq empty "$FILE" 2>/dev/null; then
                echo "‚ùå Invalid JSON in: $FILE"
                ARTIFACTS_VALID="false"
              else
                echo "‚úÖ Valid: $FILE"
              fi
            fi
          done
          
          echo "artifacts_valid=$ARTIFACTS_VALID" >> $GITHUB_OUTPUT
          
          if [ "$ARTIFACTS_VALID" == "false" ]; then
            echo "‚ö†Ô∏è Some artifacts are missing or invalid"
          fi

      # ============================================
      # PHASE 4: READ METRICS FROM ARTIFACTS (Phase 4.6)
      # ============================================
      
      - name: Read Metrics from Artifacts
        id: read_artifacts
        run: |
          STATUS_FILE="public/audio/autopilot-status.json"
          
          if [ -f "$STATUS_FILE" ]; then
            # Read metrics directly from artifact file (not console parsing)
            BEFORE=$(jq -r '.beforeIntegrity // 0' "$STATUS_FILE")
            AFTER=$(jq -r '.afterIntegrity // 0' "$STATUS_FILE")
            APPLIED=$(jq -r '.changesApplied // 0' "$STATUS_FILE")
            BLOCKED=$(jq -r '.changesBlocked // 0' "$STATUS_FILE")
            ROOMS=$(jq -r '.roomsTouched // 0' "$STATUS_FILE")
            
            # Calculate total
            TOTAL=$((APPLIED + BLOCKED))
            
            echo "integrity_before=$BEFORE" >> $GITHUB_OUTPUT
            echo "integrity_after=$AFTER" >> $GITHUB_OUTPUT
            echo "total_changes=$TOTAL" >> $GITHUB_OUTPUT
            echo "changes_applied=$APPLIED" >> $GITHUB_OUTPUT
            echo "changes_blocked=$BLOCKED" >> $GITHUB_OUTPUT
            echo "rooms_touched=$ROOMS" >> $GITHUB_OUTPUT
            
            # Check threshold
            AFTER_INT=${AFTER%.*}
            if [ "$AFTER_INT" -ge 99 ]; then
              echo "meets_threshold=true" >> $GITHUB_OUTPUT
            else
              echo "meets_threshold=false" >> $GITHUB_OUTPUT
            fi
            
            echo "üìä Metrics loaded from artifacts:"
            echo "   Integrity: $BEFORE% ‚Üí $AFTER%"
            echo "   Changes: $APPLIED applied, $BLOCKED blocked"
          else
            # Fallback to console parsing (matches CLI printSummary format)
            echo "‚ö†Ô∏è Status artifact not found, falling back to log parsing"
            BEFORE=$(grep -oP "Before:\s*\K[\d.]+" autopilot-output.log || echo "0")
            AFTER=$(grep -oP "After:\s*\K[\d.]+" autopilot-output.log || echo "0")
            APPLIED=$(grep -oP "Applied:\s*\K\d+" autopilot-output.log || echo "0")
            BLOCKED=$(grep -oP "Blocked:\s*\K\d+" autopilot-output.log || echo "0")
            
            echo "integrity_before=$BEFORE" >> $GITHUB_OUTPUT
            echo "integrity_after=$AFTER" >> $GITHUB_OUTPUT
            echo "total_changes=$((APPLIED + BLOCKED))" >> $GITHUB_OUTPUT
            echo "changes_applied=$APPLIED" >> $GITHUB_OUTPUT
            echo "changes_blocked=$BLOCKED" >> $GITHUB_OUTPUT
            
            AFTER_INT=${AFTER%.*}
            if [ "$AFTER_INT" -ge 99 ]; then
              echo "meets_threshold=true" >> $GITHUB_OUTPUT
            else
              echo "meets_threshold=false" >> $GITHUB_OUTPUT
            fi
          fi

      # ============================================
      # PHASE 5: INTEGRITY GATE (‚â•99%)
      # ============================================
      
      - name: Check Integrity Gate
        id: integrity_gate
        run: |
          AFTER="${{ steps.read_artifacts.outputs.integrity_after }}"
          THRESHOLD=99
          
          # Handle decimal comparison
          AFTER_INT=$(echo "$AFTER" | cut -d. -f1)
          
          if [ "$AFTER_INT" -lt "$THRESHOLD" ]; then
            echo "‚ö†Ô∏è WARNING: System integrity ($AFTER%) below threshold ($THRESHOLD%)"
            echo "gate_passed=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ System integrity ($AFTER%) meets threshold ($THRESHOLD%)"
            echo "gate_passed=true" >> $GITHUB_OUTPUT
          fi

      # ============================================
      # PHASE 6: UPLOAD ARTIFACTS
      # ============================================
      
      - name: Upload Autopilot Artifacts
        uses: actions/upload-artifact@v4
        if: steps.validate_artifacts.outputs.artifacts_valid == 'true'
        with:
          name: autopilot-artifacts
          path: |
            public/audio/autopilot-status.json
            public/audio/autopilot-report.json
            public/audio/autopilot-changeset.json
            public/audio/autopilot-history.json
          retention-days: 30
          if-no-files-found: warn

      - name: Compress and Upload Logs (Phase 4.6)
        run: |
          # Compress logs to save space
          gzip -k autopilot-output.log test-results.log 2>/dev/null || true
          
      - name: Upload Logs
        uses: actions/upload-artifact@v4
        with:
          name: autopilot-logs
          path: |
            autopilot-output.log.gz
            autopilot-output.log
            test-results.log.gz
            test-results.log
          retention-days: 7

      # ============================================
      # PHASE 7: CHECK FOR CHANGES (No Surprise Mode)
      # ============================================
      
      - name: Check for Actual Changes
        id: changes
        run: |
          git diff --name-only > changed-files.txt
          
          # Filter to only audio/data files
          grep -E "^(public/audio|public/data)" changed-files.txt > relevant-changes.txt || true
          
          CHANGE_COUNT=$(wc -l < relevant-changes.txt | tr -d ' ')
          
          if [ "$CHANGE_COUNT" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "change_count=$CHANGE_COUNT" >> $GITHUB_OUTPUT
            echo "Changed files ($CHANGE_COUNT):"
            cat relevant-changes.txt | head -30
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "change_count=0" >> $GITHUB_OUTPUT
            echo "No actual content changes detected"
          fi

      # ============================================
      # PHASE 8: COMMIT (only if changes exist and apply mode)
      # ============================================
      
      - name: Commit Changes
        if: |
          steps.changes.outputs.has_changes == 'true' && 
          (github.event.inputs.apply_fixes == 'true' || github.event.inputs.run_autopilot == 'true')
        run: |
          git config --local user.email "automation@mercyblade.app"
          git config --local user.name "Audio Autopilot v4.6"
          
          # Add all relevant files
          git add public/audio || true
          git add public/data || true
          
          git commit -m "[skip ci] Audio Autopilot v4.6 - Governed Repairs" \
            -m "ü§ñ Full Autopilot with Governance Engine" \
            -m "" \
            -m "Integrity: ${{ steps.read_artifacts.outputs.integrity_before }}% ‚Üí ${{ steps.read_artifacts.outputs.integrity_after }}%" \
            -m "Changes: ${{ steps.read_artifacts.outputs.total_changes }} total (${{ steps.read_artifacts.outputs.changes_applied }} applied, ${{ steps.read_artifacts.outputs.changes_blocked }} blocked)" \
            -m "Gate: ${{ steps.integrity_gate.outputs.gate_passed == 'true' && '‚úÖ PASSED' || '‚ö†Ô∏è BELOW THRESHOLD' }}" \
            -m "Mode: ${{ github.event.inputs.cycle_mode || 'normal' }}"
          
          git push

      # ============================================
      # SUMMARY REPORT
      # ============================================
      
      - name: Generate Summary Report
        run: |
          BEFORE=${{ steps.read_artifacts.outputs.integrity_before }}
          AFTER=${{ steps.read_artifacts.outputs.integrity_after }}
          TOTAL=${{ steps.read_artifacts.outputs.total_changes }}
          APPLIED=${{ steps.read_artifacts.outputs.changes_applied }}
          BLOCKED=${{ steps.read_artifacts.outputs.changes_blocked }}
          GATE=${{ steps.integrity_gate.outputs.gate_passed }}
          CHANGES=${{ steps.changes.outputs.change_count || 0 }}
          ARTIFACTS_VALID=${{ steps.validate_artifacts.outputs.artifacts_valid }}
          
          echo "## ü§ñ Audio Autopilot v4.6 Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Status Badge
          if [ "$GATE" == "true" ]; then
            echo "### ‚úÖ PASSED - System Healthy (‚â•99%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ö†Ô∏è WARNING - Below Threshold (<99%)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Artifact Validation (Phase 4.6)
          echo "### üîç Artifact Validation" >> $GITHUB_STEP_SUMMARY
          if [ "$ARTIFACTS_VALID" == "true" ]; then
            echo "‚úÖ All artifacts valid JSON" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Some artifacts missing or invalid" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test Results
          echo "### üß™ Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.audio_tests.outputs.tests_passed }}" == "true" ]; then
            echo "‚úÖ All audio tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Integrity Summary
          echo "### üìä System Integrity" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Before | After |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Integrity Score** | ${BEFORE}% | ${AFTER}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **Threshold** | 99% | 99% |" >> $GITHUB_STEP_SUMMARY
          
          # Calculate delta
          if [ -n "$BEFORE" ] && [ -n "$AFTER" ]; then
            BEFORE_INT=${BEFORE%.*}
            AFTER_INT=${AFTER%.*}
            if [ "$AFTER_INT" -ge "$BEFORE_INT" ]; then
              DELTA="‚Üë +$((AFTER_INT - BEFORE_INT))%"
            else
              DELTA="‚Üì -$((BEFORE_INT - AFTER_INT))%"
            fi
            echo "| **Change** | - | $DELTA |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Changes Summary
          echo "### üîß Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Changes | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| Applied | $APPLIED |" >> $GITHUB_STEP_SUMMARY
          echo "| Blocked | $BLOCKED |" >> $GITHUB_STEP_SUMMARY
          echo "| Files Changed | $CHANGES |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Cycle Mode (Phase 4.6)
          echo "### ‚öôÔ∏è Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Cycle Mode**: ${{ github.event.inputs.cycle_mode || 'normal' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Apply Mode**: ${{ github.event.inputs.apply_fixes || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Room Filter**: ${{ github.event.inputs.rooms || '(all)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Artifacts
          echo "### üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`autopilot-status.json\` - Persistent status store" >> $GITHUB_STEP_SUMMARY
          echo "- \`autopilot-report.json\` - Full run report" >> $GITHUB_STEP_SUMMARY
          echo "- \`autopilot-changeset.json\` - Categorized changes" >> $GITHUB_STEP_SUMMARY
          echo "- \`autopilot-history.json\` - Last 20 cycles" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Commands
          echo "### üíª Local Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Quick scan (skip TTS + semantic)" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/run-audio-autopilot.ts --dry-run --fast" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Full deep scan" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/run-audio-autopilot.ts --dry-run --deep" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Apply fixes" >> $GITHUB_STEP_SUMMARY
          echo "npx tsx scripts/run-audio-autopilot.ts --apply --verbose" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      # ============================================
      # FAIL IF INTEGRITY GATE NOT PASSED (Phase 4.6)
      # ============================================
      
      - name: Enforce Integrity Gate
        if: steps.integrity_gate.outputs.gate_passed == 'false' && github.event.inputs.apply_fixes == 'true'
        run: |
          echo "‚ùå Integrity gate failed: System integrity below 99%"
          echo "Review the autopilot report and address blocking issues"
          exit 1

      # ============================================
      # FAIL IF ARTIFACTS INVALID (Phase 4.6)
      # ============================================
      
      - name: Enforce Artifact Validity
        if: steps.validate_artifacts.outputs.artifacts_valid == 'false' && github.event.inputs.apply_fixes == 'true'
        run: |
          echo "‚ùå Artifact validation failed: Some artifacts are missing or invalid JSON"
          echo "Check the autopilot script output for errors"
          exit 1
