// src/AppRouter.tsx
// MB-BLUE-100.4 ‚Äî 2025-12-31 (+0700)
//
// ROUTING RULES (LOCKED):
// - Canonical room route: /room/:roomId
// - Legacy/bad routes are redirected silently
// - /room (no id) must NOT show NotFound
// - No resolver logic here
//
// FIX (100.4):
// - Mount BottomMusicBar ONCE at app-shell level
// - Remove it from ChatHub
// - Guarantees identical alignment with room content
// - Stops layout fights / overflow forever
//
// ENHANCE (100.4a ‚Äî 2026-01-25):
// - Force ChatHub remount on roomId change (prevents stale per-room styling/highlights sticking)

import { Routes, Route, Navigate, useParams } from "react-router-dom";

import ChatHub from "@/pages/ChatHub";
import AllRooms from "@/pages/AllRooms";
import NotFound from "@/_legacy_next_pages/NotFound";
import BottomMusicBar from "@/components/audio/BottomMusicBar";

/**
 * Legacy fix:
 * /room/room/:roomId  ‚Üí  /room/:roomId
 */
function RoomRoomRedirect() {
  const { roomId } = useParams<{ roomId: string }>();
  return <Navigate to={roomId ? `/room/${roomId}` : "/"} replace />;
}

/**
 * Safety fix:
 * /room  ‚Üí  /
 * (Important: must not render NotFound)
 */
function RoomIndexRedirect() {
  return <Navigate to="/" replace />;
}

/**
 * Canonical room route wrapper:
 * Force remount when roomId changes so per-room UI (keywords/highlights/styles) can‚Äôt get ‚Äústuck‚Äù.
 */
function RoomRoute() {
  const { roomId } = useParams<{ roomId: string }>();
  return <ChatHub key={roomId || "room"} />;
}

/**
 * GLOBAL APP SHELL (LOCKED)
 * - Owns BottomMusicBar
 * - Routes render INSIDE this shell
 */
function AppShell({ children }: { children: React.ReactNode }) {
  return (
    <>
      {children}
      <BottomMusicBar />
    </>
  );
}

export default function AppRouter() {
  return (
    <AppShell>
      <Routes>
        {/* Main landing */}
        <Route path="/" element={<AllRooms />} />

        {/* üîÅ Legacy fixes (explicit, silent) */}
        <Route path="/room/room/:roomId" element={<RoomRoomRedirect />} />
        <Route path="/room/" element={<RoomIndexRedirect />} />
        <Route path="/room" element={<RoomIndexRedirect />} />

        {/* ‚úÖ Canonical room route */}
        <Route path="/room/:roomId" element={<RoomRoute />} />

        {/* Fallback */}
        <Route path="*" element={<NotFound />} />
      </Routes>
    </AppShell>
  );
}

/* teacher GPT ‚Äî new thing to learn:
   When UI depends on route params (room keywords/styles), remount-by-key prevents ‚Äústicky‚Äù state.
   It‚Äôs a safe fix because it doesn‚Äôt change logic‚Äîonly resets per-room component state. */
